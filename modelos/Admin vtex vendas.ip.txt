this.montaTabelaVendaAbraCadabra = "";
this.montaTabelaVendaAbraMais = "";
this.montaTabelaVendaAbraCasa = "";

this.objV = "";
this.tela = "";

this.activity("run", function (){
    this.montaTabelaVendaAbraMais = "";
    this.montaTabelaVendaAbraCasa = "";
    this.montaTabelaVendaAbraCadabra = "";
    this.montaTabelaRecursosaAbraMais = "";
    this.montaTabelaRecursosaAbraCasa = "";
    this.montaTabelaRecursosaAbraCadabra = "";

    this.recursosAbraMais = new DataSet();
    this.recursosAbraMais.createField("CODIGO", "string", 30);
    this.recursosAbraMais.createField("NOME", "string", 200);
    this.recursosAbraMais.createField("QUANTIDADE", "integer");
    this.recursosAbraMais.createField("PRECO", "number");
    this.recursosAbraMais.create();

    this.recursosAbraCasa = new DataSet();
    this.recursosAbraCasa.createField("CODIGO", "string", 30);
    this.recursosAbraCasa.createField("NOME", "string", 200);
    this.recursosAbraCasa.createField("QUANTIDADE", "integer");
    this.recursosAbraCasa.createField("PRECO", "number");
    this.recursosAbraCasa.create();

    this.recursosAbraCadabra = new DataSet();
    this.recursosAbraCadabra.createField("CODIGO", "string", 30);
    this.recursosAbraCadabra.createField("NOME", "string", 200);
    this.recursosAbraCadabra.createField("QUANTIDADE", "integer");
    this.recursosAbraCadabra.createField("PRECO", "number");
    this.recursosAbraCadabra.create();

    this.status = "Buscando informações de venda - VTEX..."
    this.objV = this.infoVendas();
    var ticketMedioAbraMais = 0.00;
    var ticketMedioAbraCasa = 0.00;
    var ticketMedioAbraCadabra = 0.00;

    if((this.objV.totalVendaAbraCadabra > 0.00) && (this.objV.totalVendaAbraCadabra)){
        ticketMedioAbraCadabra = this.converteMonetario(this.objV.totalVendaAbraCadabra/this.objV.qtdTotalVendaAbraCadabra);
    }else{
        ticketMedioAbraCadabra = this.converteMonetario(0);
    }

    if((this.objV.totalVendaAbraCasa > 0.00) && (this.objV.totalVendaAbraCasa)){
        ticketMedioAbraCasa = this.converteMonetario(this.objV.totalVendaAbraCasa/this.objV.qtdTotalVendaAbraCasa);
    }else{
        ticketMedioAbraCasa = this.converteMonetario(0);
    }

     if((this.objV.totalVendaAbraMais > 0.00) && (this.objV.totalVendaAbraMais)){
        ticketMedioAbraMais = this.converteMonetario(this.objV.totalVendaAbraMais/this.objV.qtdTotalVendaAbraMais);
    }else{
        ticketMedioAbraMais = this.converteMonetario(0);
    }

    this.montaTabelaVendaAbraCadabra = "<tr>
                        <td>"+this.objV.qtdTotalVendaAbraCadabra+"</td>
                        <td>R$ "+ticketMedioAbraCadabra+"</td>
                        <td>R$ "+this.converteMonetario(this.objV.totalVendaAbraCadabra)+"</td>
                    </tr>
                 ";

    this.montaTabelaVendaAbraMais = "<tr>
                        <td>"+this.objV.qtdTotalVendaAbraMais+"</td>
                        <td>R$ "+ticketMedioAbraMais+"</td>
                        <td>R$ "+this.converteMonetario(this.objV.totalVendaAbraMais)+"</td>
                    </tr>
                 ";

    this.montaTabelaVendaAbraCasa = "<tr>
                        <td>"+this.objV.qtdTotalVendaAbraCasa+"</td>
                        <td>R$ "+ticketMedioAbraCasa+"</td>
                        <td>R$ "+this.converteMonetario(this.objV.totalVendaAbraCasa)+"</td>
                    </tr>
                 ";

    this.paginaAdmin = "

<html>
<head>
    <meta charset='Windows-1252'/>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>

    <style>

        th,td {
            text-align: center;
            font-size: 14px;
            padding: 8px;
        }

        .tddescricao {
            font-size: 14px;
            line-height: 1;
            text-align: left;
            padding: 8px;
        }

        h4 {
            font-size: 12px;
        }

        tr:nth-child(even){
            background-color: #f2f2f2
        }

        .thcadabra {
            background-color: orange;
            color: white;
        }

        .thcasa {
            background-color: #a10626;
            color: white;
        }

        .thmais {
            background-color: orange;
            color: white;
        }

        #tab1{
        	position:relative;
        	width:90%;        	
        	left:5%;
            right:5%;     	
        }

        #tabrecursos1{
        	position:relative;
        	width:90%;
        	left:5%;
            right:5%;
        }

        #tab2 {
        	position:relative;
        	width:90%;        	
            left:5%;
            right:5%;
        	     	
        }

        #tabrecursos2 {
        	position:relative;
        	width:90%;
        	left:5%;
            right:5%;       	
        }

        #tab3 {
        	position:relative;
        	width:90%;
            left:5%;
            right:5%;     	
        }

        #tabrecursos3 {
        	position:relative;
        	width:90%;
        	left:5%;
            right:5%;      	
        }

        .divesq {
        	position:relative;
        	width:90%;        	
        	left:4%;
			right:5%;        	
        }

        .divmeio {
        	position:relative;
        	width:90%;        	
        	left:5%;
			right:5%;        	
        }

        .divdir {
        	position:relative;
        	width:90%;        	
        	left:5%;
			right:5%;        	
        }

    </style>
</head>
<body>

<div class='container-fluid'>
    <div>
        <div>
            <h2 class='divesq'>ABRA CADABRA</h2>
                <table id='tab1' border='1'>
                <tr>
                    <th class='thcadabra'>VENDAS</th>
                    <th class='thcadabra'>TICKET MÉDIO</th>
                    <th class='thcadabra'>RECEITA</th>
                </tr>
                "+this.montaTabelaVendaAbraCadabra+"
            </table>
        </div>
        <div>
            <h2 class='divmeio'>ABRA CASA</h2>
                <table id='tab2' border='1'>
                <tr>
                    <th class='thcasa'>VENDAS</th>
                    <th class='thcasa'>TICKET MÉDIO</th>
                    <th class='thcasa'>RECEITA</th>
                </tr>

                "+this.montaTabelaVendaAbraCasa+"
            </table>
        </div>
        <div>
            <h2 class='divdir'>MARKET PLACE</h2>
                <table id='tab3' border='1'>
                <tr>
                    <th  class='thmais'>VENDAS</th>
                    <th  class='thmais'>TICKET MÉDIO</th>
                    <th  class='thmais'>RECEITA</th>
                </tr>

                "+this.montaTabelaVendaAbraMais+"
            </table>
        </div>
  </div>
 </div>
</body>
</html>
    ";

})

this.interaction("Principal", function (){
    this.visibleActions = [ "Atualizar"];

    this.write(this.paginaAdmin);

    this.botao.timer.interval = 60000;
    this.botao.timer.enabled  = true;


});

this.botao = this.action( "Atualizar", function ( action ) {
    var act = action.process;
    var actp = action.parent;
    act.montaTabelaVendaAbraMais = "";
    act.montaTabelaVendaAbraCasa = "";
    act.montaTabelaVendaAbraCadabra = "";
    act.montaTabelaRecursosaAbraMais = "";
    act.montaTabelaRecursosaAbraCasa = "";
    act.montaTabelaRecursosaAbraCadabra = "";
    act.status = "Atualizando informações de venda da VTEX..."
    action.process.setNextInteraction( "run" )
});

this.buscaVendasVtexAbraMais = function buscaVendasVtexAbraMais(pagina){

    var xhr = new XMLHttpRequest();

    xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var myArr = JSON.parse(this.responseText);
            //myFunction(myArr);
        }
    };

    this.addZero = function addZero(numero){
        var corrigido = "";

        if(numero <= 9){
            corrigido = "0"+numero;
        }else{
            corrigido = numero;
        }

        return corrigido;

    }

    var data = new Date();
    var dataFim = (new Date()) + 1;

    data = data.getFullYear()+"-"+this.addZero(data.getMonth()+1)+"-"+this.addZero(data.getDate())
    dataFim = dataFim.getFullYear()+"-"+this.addZero(dataFim.getMonth()+1)+"-"+this.addZero(dataFim.getDate())

    var url = "https://abramais.myvtex.com/api/oms/pvt/orders/?orderBy=creationDate,desc&f_creationDate=creationDate:%5B"+data+"T03:00:00.000Z%20TO%20"+dataFim+"T02:59:59.999Z%5D&utc=-0200&per_page=100&page="+pagina;

    xhr.open("GET", url);
    xhr.setRequestHeader("X-VTEX-API-AppKey", "vtexappkey-abramais-NJFRFU")
    xhr.setRequestHeader("X-VTEX-API-AppToken", "DNIRZLTQJHYUDUGLXNKRCXHKTVVEWXJPSPWTVSTWGFJWOINDTJIBIACFFXXEPPUMYJCOYMPETOLWNLWKHRLNOHHRMQNXUPGRLXXFGYFGTDITPGSUAMWYDGXRBLCIZSKE")

    xhr.send();

    msg = xhr.responseText

    var obj = JSON.parse(msg);

    return obj;
}

this.buscaVendasVtexAbraCasa = function buscaVendasVtexAbraCasa(pagina){

    var xhr = new XMLHttpRequest();

    xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var myArr = JSON.parse(this.responseText);
            //myFunction(myArr);
        }
    };

    this.addZero = function addZero(numero){
        var corrigido = "";

        if(numero <= 9){
            corrigido = "0"+numero;
        }else{
            corrigido = numero;
        }

        return corrigido;
    }

    var data = new Date();
    var dataFim = (new Date()) + 1;

    data = data.getFullYear()+"-"+this.addZero(data.getMonth()+1)+"-"+this.addZero(data.getDate())
    dataFim = dataFim.getFullYear()+"-"+this.addZero(dataFim.getMonth()+1)+"-"+this.addZero(dataFim.getDate())

    var url = "https://abracasa.myvtex.com/api/oms/pvt/orders/?orderBy=creationDate,desc&f_creationDate=creationDate:%5B"+data+"T03:00:00.000Z%20TO%20"+dataFim+"T02:59:59.999Z%5D&utc=-0200&per_page=100&page="+pagina;

    xhr.open("GET", url);
    xhr.setRequestHeader("X-VTEX-API-AppKey", "vtexappkey-abracasa-ALPXOA")
    xhr.setRequestHeader("X-VTEX-API-AppToken", "GPYPEPWLVPLINMRINWUNQFZBTWUZQVUUUJHAQUHEIQTIJCOIRRWKCMHBQWVHVXUZUQNDFQRTOQFZLQRRHLHZZKSIBGKUYZIKWUNTOLDAZCWMHHPZFDAJPUAKYFBZGXUO")

    xhr.send();
    msg = xhr.responseText

    var obj = JSON.parse(msg);

    return obj;
}

this.retornaItemPedido = function retornaItemPedido(loja,orderIdVtex){
    var xhr = new XMLHttpRequest();
    var statusRetorno = "";

    xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var myArr = JSON.parse(this.responseText);
            //myFunction(myArr);
        }
    };
    if(loja == "mais" /* -1895832769 Estab ABM IMS */  || loja == "cadabra" /* -1895833694 Estab ABR INT */){
        var url = "https://abramais.myvtex.com/api/oms/pvt/orders/"+orderIdVtex
        xhr.open("GET", url);
        xhr.setRequestHeader("Content-type", "application/json");
        xhr.setRequestHeader("X-VTEX-API-AppKey", "vtexappkey-abramais-NJFRFU")
        xhr.setRequestHeader("X-VTEX-API-AppToken", "DNIRZLTQJHYUDUGLXNKRCXHKTVVEWXJPSPWTVSTWGFJWOINDTJIBIACFFXXEPPUMYJCOYMPETOLWNLWKHRLNOHHRMQNXUPGRLXXFGYFGTDITPGSUAMWYDGXRBLCIZSKE")
    }else{
        if(loja == "casa" /* -1895832771 Estab ABC ICS Zeni */){
            var url = "https://abracasa.myvtex.com/api/oms/pvt/orders/"+orderIdVtex
            xhr.open("GET", url);
            xhr.setRequestHeader("X-VTEX-API-AppKey", "vtexappkey-abracasa-ALPXOA")
            xhr.setRequestHeader("X-VTEX-API-AppToken", "GPYPEPWLVPLINMRINWUNQFZBTWUZQVUUUJHAQUHEIQTIJCOIRRWKCMHBQWVHVXUZUQNDFQRTOQFZLQRRHLHZZKSIBGKUYZIKWUNTOLDAZCWMHHPZFDAJPUAKYFBZGXUO")

        }else{
            statusRetorno =  " Loja não cadastrada. Não há parâmetros para a loja virtual informada...";
        }
    }
    xhr.send();

    msg = xhr.responseText

    var obj = JSON.parse(msg);
}

this.converte = function converte(num) {
    num = num+"";
    num = num.substring(0, num.length-2) +","+ num.substring(num.length-2, num.length);
    num = Number(num)
    return num
}

this.converteMonetario = function converteMonetario(num) {
    var p = num.toFixed(2).split(".");
    return p[0].split("").reverse().reduce(function(acc, num, i, orig) {
        return  num=="-" ? acc : num + (i && !(i % 3) ? "." : "") + acc;
    }, "") + "," + p[1];
}


this.infoVendas = function infoVendas(){
    var objVenda = { qtdTotalVendaAbraMais: 0,
                     totalVendaAbraMais: 0,
                     qtdTotalVendaAbraCasa: 0,
                     totalVendaAbraCasa: 0,
                     qtdTotalVendaAbraCadabra: 0,
                     totalVendaAbraCadabra: 0};

    this.recursosAbraMais.empty();
    this.recursosAbraCasa.empty();
    this.recursosAbraCadabra.empty();

    var pagina = 1;
    var continueLendo = true;
    var obj = "";

    while(continueLendo){
        obj = this.buscaVendasVtexAbraMais(pagina);

        if(obj.list.length == 0){
            continueLendo = false;
        }else{
            for(var i=0; i<obj.list.length; i++){
                if(obj.list[i].salesChannel != 1){
                    objVenda.totalVendaAbraMais += Number(this.converte(obj.list[i].totalValue));
                    objVenda.qtdTotalVendaAbraMais ++;
                }else{
                    objVenda.totalVendaAbraCadabra += Number(this.converte(obj.list[i].totalValue));
                    objVenda.qtdTotalVendaAbraCadabra++;
                }
            }
            //objVenda.qtdTotalVendaAbraMais += obj.list.length;
            obj = "";
            pagina++;
        }
    }

    pagina = 1;
    continueLendo = true;

    while(continueLendo){
        objCasa = this.buscaVendasVtexAbraCasa(pagina);

        if(objCasa.list.length == 0){
            continueLendo = false;
        }else{
            for(var i=0; i<objCasa.list.length; i++){
                 objVenda.totalVendaAbraCasa += Number(this.converte(objCasa.list[i].totalValue));
            }
            objVenda.qtdTotalVendaAbraCasa += objCasa.list.length;
            objCasa = "";
            pagina++;
        }
    }
    return objVenda;
}


this.montaGradeVtex = function montaGradeVtex(tela){

    var grid = this.grid( "gridVtex")
        grid.hasFormView = true
        grid.hasTableView = false
        grid.title = "Admin Vtex"

        grid.onDefineFields.set( function ( grid ){
            var fld = grid.field("image_", "memo")
            fld.label = "";
            fld.controlType = "none"
            fld.width = 160
            fld.help = "Mostra os valores de venda na VTEX."
            fld.onCalculate.set( function ( fld ){
                return tela
            })
        })
}


this.removeCaracterEspecial = function removeCaracterEspecial(str)
{
    codErrado  = ["Ã§","Ã ","Ã¡","Ã¢","Ã£","Ã©","Ãª","Ã","Ã³","Ã´","Ãµ","Ãº"];
    codCorreto = ["ç" ,'à' ,'á' ,'â' ,'ã' ,'é' ,'ê' ,'í','ó' ,'ô' ,'õ' ,'ú'];

    novastr = str.replace("Ã§","ç");
    novastr = novastr.replace("Ã¡",'á');
    novastr = novastr.replace("Ã¢",'â');
    novastr = novastr.replace("Ã£",'ã');
    novastr = novastr.replace("Ã©",'é');
    novastr = novastr.replace("Ãª",'ê');
    novastr = novastr.replace("Ã ",'í');
    novastr = novastr.replace("Ã³",'ó');
    novastr = novastr.replace("Ã´",'ô');
    novastr = novastr.replace("Ãµ",'õ');
    novastr = novastr.replace("Ãº",'ú');

    return novastr;
}